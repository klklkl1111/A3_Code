<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>add</title>
  <link href="css/public.css" rel="stylesheet" type="text/css">
</head>
<body>
  <div id="dcWrap">
    <div id="dcHead">
      <div id="head">
        <div class="logo"><a href="#" style="line-height: 1.5;color: aliceblue;font-weight: 900;font-size: 24px;">administration</a></div>
        <div class="nav">
          <ul class="navRight">
            <li class="M noLeft"><a href="#">您好，admin</a></li>
            <li class="noRight"><a href="#">退出</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="dcLeft">
      <div id="menu">
        <ul>
          <li class="cur"><a href="fundariser.html"><i class="fundariser"></i><em>fundariser</em></a></li>
        </ul>
      </div>
    </div>
    <div id="dcMain">
      <div class="mainBox" style="height:auto!important;height:550px;min-height:550px;">
        <h3 id="title"></h3>
        <form>
          <table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
            <tr>
              <td width="90" align="right">CAPTION</td>
              <td>
                <input id="caption" type="text" name="title" value="" size="80" class="inpMain" />
              </td>
            </tr>
            <tr>
              <td align="right">CATEGORY</td>
              <td>
                <select id="category" style="width: 800px;height: 38px;"></select>
              </td>
            </tr>
            <tr>
              <td align="right">ORGANIZER</td>
              <td>
                <input id="organizer" type="text" name="keywords" value="" size="50" class="inpMain" />
              </td>
            </tr>
            <tr>
              <td align="right">CITY</td>
              <td>
                <input id="city" type="text" name="description" value="" size="50" class="inpMain" />
              </td>
            </tr>
            <tr>
              <td align="right">TARGET_FUNDING</td>
              <td>
                <input id="target" type="number" name="keywords" value="" size="50" class="inpMain" />
              </td>
            </tr>
            <tr>
              <td align="right">STATUS</td>
              <td>
                <select id="status" name="CATEGORY_id" style="width: 800px;height: 38px;">
                  <option value="0">ACTIVE</option>
                  <option value="1">SUSPENDED</option>
                </select>
              </td>
            </tr>
            <tr>
              <td align="right" valign="top">DESCRIBE</td>
              <td>
                <textarea id="content" name="content" style="width:788px;height:200px;" class="textArea"></textarea>
              </td>
            </tr>
            <tr>
              <td align="right">PICTURE</td>
              <td>
                <input id="pic" type="file" name="image" size="38" class="inpFlie" />
              </td>
            </tr>
          </table>
        </form>
      </div>
    </div>
    <script>
      let fid;
      const caption = document.querySelector('#caption');
      const organizer = document.querySelector('#organizer')
      const category = document.querySelector('#category');
      const city = document.querySelector('#city');
      const target = document.querySelector('#target');
      const status = document.querySelector('#status');
      const content = document.querySelector('#content');
      const pic = document.querySelector('#pic');
      window.onload = function () {
        getCategory()
        getId()
        upload()
      }
      function getId() {
        var url = location.search;
        if (url.indexOf("?") != -1) {
          var text = url.substr(1);
          ids = text.split("=");
          if (ids[1]) {
            fid = ids[1]
            document.querySelector('#title').innerHTML = '<a href="fundariser.html" class="actionBtn">list</a>Edit'
            getDetail(ids[1])
          } else {
            document.querySelector('#title').innerHTML = '<a href="fundariser.html" class="actionBtn">list</a>Add'
          }
        }
      }
      function getCategory() {
        const list = document.querySelector('#category')
        let inner = ''
        fetch('http://localhost:8999/api/category').then(res => {
          return res.json()
        }).then(response => {
          response.forEach(item => {
            inner += `<option value="` + item.CATEGORY_ID + `">` + item.NAME + `</option>`
          })
          list.innerHTML = inner
        })
      }
      function getDetail(id) {
        fetch('http://localhost:8999/api/fundraiser/' + id).then(res => {
          return res.json()
        }).then(response => {
          const data = response[0]
          caption.value = data.CAPTION
          organizer.value = data.ORGANIZER
          category.value = data.CATEGORY_ID
          city.value = data.CITY
          target.value = data.TARGET_FUNDING
          status.value = data.ACTIVE
          content.value = data.DESCRIBE
        })
      }
      function upload() {
        pic.addEventListener('change', async () => {
          const file = pic.files[0];
          if (!file) return;
          const formData = new FormData();
          formData.append('image', file);
          try {
            fetch('http://localhost:8999/api/upload', {
              method: 'POST',
              body: formData
            }).then(res => res.json()).then(response => {
              submit(response.data);
              alert('Submit Infomation Success!')
            })
          } catch (error) {
            console.error('error', error);
          }
        });
      }
      function submit(imgPath) {
        const data = {
          caption: caption.value,
          organizer: organizer.value,
          category: category.value,
          city: city.value,
          status: status.value,
          target: target.value,
          describe: content.value,
          url: imgPath
        }
        if (fid) {
          data.id = fid
          fetch('http://localhost:8999/api/updateData', {
            method: 'PUT',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json'
            }
          })
            .then(response => response.json())
            .then(data => {
              console.log('success');
            })
        } else {
          fetch('http://localhost:8999/api/insertData', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
              'Content-Type': 'application/json'
            }
          })
            .then(response => response.json())
            .then(data => {
              console.log('success');
            })
        }
      }
    </script>
</body>

</html>